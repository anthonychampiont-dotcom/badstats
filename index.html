<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BadStats">
<meta name="theme-color" content="#0a0e14">
<link rel="manifest" href="manifest.json">
<title>BadStats</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

/* ‚ïê‚ïê‚ïê RESET & BASE ‚ïê‚ïê‚ïê */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

:root {
  --bg:      #0a0e14;
  --surface: #10161f;
  --card:    #141c28;
  --border:  #1e2d42;
  --border2: #253550;
  --text:    #e2eaf8;
  --muted:   #4a6080;
  --muted2:  #6a80a0;
  --green:   #00e676;
  --win:     #2979ff;
  --win-bg:  rgba(41,121,255,.13);
  --win-bd:  rgba(41,121,255,.4);
  --lose:    #ff2d55;
  --lose-bg: rgba(255,45,85,.13);
  --lose-bd: rgba(255,45,85,.4);
  --safe-t: env(safe-area-inset-top, 0px);
  --safe-b: env(safe-area-inset-bottom, 0px);
  --safe-l: env(safe-area-inset-left, 0px);
  --safe-r: env(safe-area-inset-right, 0px);
}

html {
  height: 100%;
  background: var(--bg);
}
body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  padding-top: var(--safe-t);
  padding-bottom: var(--safe-b);
  padding-left: var(--safe-l);
  padding-right: var(--safe-r);
}

/* ‚ïê‚ïê‚ïê CONFIG MODAL ‚ïê‚ïê‚ïê */
.cfg-modal {
  position: fixed; inset: 0; z-index: 999;
  background: rgba(0,0,0,.92);
  backdrop-filter: blur(12px);
  display: flex; align-items: center; justify-content: center;
  padding: 16px;
}
.cfg-modal.hidden { display: none; }

.cfg-box {
  background: var(--card);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 24px 20px;
  width: 100%; max-width: 460px;
  max-height: 92vh;
  overflow-y: auto;
}

.cfg-logo {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2rem; letter-spacing: 4px;
  color: var(--green); margin-bottom: 2px;
}
.cfg-sub { color: var(--muted2); font-size: .82rem; margin-bottom: 18px; }

.mode-tabs {
  display: flex; background: var(--surface);
  border: 1px solid var(--border); border-radius: 12px;
  padding: 3px; gap: 3px; margin-bottom: 16px;
}
.mode-tab {
  flex: 1; padding: 12px 8px; border: none; border-radius: 9px;
  font-family: 'Outfit', sans-serif; font-size: .88rem; font-weight: 700;
  cursor: pointer; transition: all .2s; background: transparent;
  color: var(--muted); text-align: center;
}
.mode-tab span { display: block; font-size: .68rem; font-weight: 400; opacity: .7; margin-top: 2px; }
.mode-tab.on { background: var(--green); color: #000; }

.cfg-group { margin-bottom: 13px; }
.cfg-group-title { font-size: .65rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); font-weight: 700; margin-bottom: 6px; }
.cfg-row { display: flex; gap: 10px; }
.cfg-field { display: flex; flex-direction: column; gap: 4px; flex: 1; }
.cfg-field label { font-size: .68rem; color: var(--muted2); font-weight: 600; }
.cfg-field input {
  background: var(--surface); border: 1px solid var(--border2);
  border-radius: 9px; padding: 11px 12px; color: var(--text);
  font-family: 'Outfit', sans-serif; font-size: .9rem;
  outline: none; width: 100%; -webkit-appearance: none;
}
.cfg-field input:focus { border-color: var(--green); }

.cfg-start {
  width: 100%; padding: 14px; background: var(--green);
  border: none; border-radius: 11px; color: #000;
  font-family: 'Outfit', sans-serif; font-size: .95rem; font-weight: 800;
  cursor: pointer; margin-top: 4px; letter-spacing: .5px;
  -webkit-appearance: none;
}
.cfg-start:active { opacity: .85; }

/* ‚ïê‚ïê‚ïê EXPORT MODAL ‚ïê‚ïê‚ïê */
.exp-modal {
  position: fixed; inset: 0; z-index: 998;
  background: rgba(0,0,0,.88);
  backdrop-filter: blur(8px);
  display: none; align-items: center; justify-content: center; padding: 16px;
}
.exp-modal.show { display: flex; }
.exp-box {
  background: var(--card); border: 1px solid var(--border2);
  border-radius: 16px; padding: 20px;
  width: 100%; max-width: 520px; max-height: 85vh; overflow-y: auto;
}
.exp-box h2 { font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px; color: var(--green); font-size: 1.3rem; margin-bottom: 10px; }
.exp-pre {
  background: var(--bg); border: 1px solid var(--border); border-radius: 7px;
  padding: 10px; font-family: 'JetBrains Mono', monospace;
  font-size: .6rem; color: var(--text); max-height: 280px;
  overflow-y: auto; white-space: pre; margin-bottom: 12px;
}
.exp-actions { display: flex; gap: 9px; justify-content: flex-end; }
.ebtn { padding: 9px 16px; border-radius: 8px; font-family: 'Outfit', sans-serif; font-weight: 700; font-size: .85rem; cursor: pointer; border: none; }
.ebtn.sec { background: var(--surface); border: 1px solid var(--border2); color: var(--text); }
.ebtn.pri { background: var(--green); color: #000; }

/* ‚ïê‚ïê‚ïê APP WRAPPER ‚ïê‚ïê‚ïê */
.app {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.hdr {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  padding: 8px 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

/* Score */
.score-row {
  display: flex; align-items: center; justify-content: center;
  background: var(--card); border: 1px solid var(--border2);
  border-radius: 12px; padding: 6px 0;
}
.score-side { flex: 1; text-align: center; padding: 0 10px; }
.score-label { font-size: .65rem; color: var(--muted2); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.score-num { font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; letter-spacing: 2px; line-height: 1; }
.score-num.w { color: var(--win); }
.score-num.l { color: var(--lose); }
.score-dash { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; color: var(--muted); }

/* Set pills */
.set-row { display: flex; gap: 4px; justify-content: center; flex-wrap: wrap; }
.set-pill { padding: 2px 9px; border-radius: 20px; border: 1px solid var(--border2); font-family: 'JetBrains Mono', monospace; font-size: .58rem; color: var(--muted); }
.set-pill.cur { border-color: var(--green); color: var(--green); }

/* Buttons row */
.btn-row {
  display: flex; gap: 6px; align-items: center;
}
.hbtn {
  padding: 8px 10px; border-radius: 9px;
  border: 1px solid var(--border2); background: transparent;
  color: var(--muted2); font-family: 'Outfit', sans-serif;
  font-size: .72rem; font-weight: 700; cursor: pointer;
  white-space: nowrap; flex-shrink: 0;
}
.hbtn:active { background: var(--border); }
.hbtn.green { border-color: var(--green); color: var(--green); }
.hbtn.green:active { background: rgba(0,230,118,.15); }
.hbtn.red { border-color: var(--lose); color: var(--lose); }
.hbtn.red:active { background: rgba(255,45,85,.15); }
.hbtn.blue { border-color: var(--win); color: var(--win); background: var(--win-bg); flex: 1; text-align: center; }
.hbtn.blue:active { background: rgba(41,121,255,.25); }

/* ‚ïê‚ïê‚ïê TABS (mobile) ‚ïê‚ïê‚ïê */
.tabs {
  display: flex; background: var(--surface);
  border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.tab {
  flex: 1; padding: 10px 4px; border: none; background: transparent;
  color: var(--muted2); font-family: 'Outfit', sans-serif;
  font-size: .76rem; font-weight: 600; cursor: pointer;
  border-bottom: 2px solid transparent;
}
.tab.on { color: var(--green); border-bottom-color: var(--green); }

/* ‚ïê‚ïê‚ïê CONTENT ‚ïê‚ïê‚ïê */
.content {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

/* ‚ïê‚ïê‚ïê PAGES ‚ïê‚ïê‚ïê */
.page {
  display: none;
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  min-height: 0;
}
.page.on { display: flex; flex-direction: column; }

/* ‚îÄ PLAYERS PAGE ‚îÄ */
.players-pg {
  padding: 8px;
  gap: 8px;
}
.players-pg.on { flex-direction: row !important; }

.pcard {
  background: var(--card);
  border: 1px solid var(--border2);
  border-radius: 14px;
  overflow: hidden;
  flex: 1;
  min-width: 0;
  position: relative;
  display: flex;
  flex-direction: column;
}

.pcard-hdr {
  padding: 8px 12px 6px;
  display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.pcard-name { font-family: 'Bebas Neue', sans-serif; font-size: 1.15rem; letter-spacing: 2px; }
.pcard-pts { font-size: .78rem; color: var(--muted2); }
.pcard-pts .w { color: var(--win); font-weight: 700; }
.pcard-pts .l { color: var(--lose); font-weight: 700; }

.pcard-body { flex: 1; overflow-y: auto; }

.zone { }
.zone-title {
  padding: 5px 10px; font-size: .62rem; font-weight: 800;
  letter-spacing: 1.2px; text-transform: uppercase;
}
.zone.win .zone-title { background: var(--win-bg); color: var(--win); }
.zone.lose .zone-title { background: var(--lose-bg); color: var(--lose); }

.zone-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 4px; padding: 6px;
  background: rgba(0,0,0,.15);
}

.abtn {
  padding: 10px 4px;
  border: 1.5px solid var(--border2); border-radius: 9px;
  background: var(--surface); color: var(--text);
  font-family: 'Outfit', sans-serif; font-size: .68rem; font-weight: 600;
  cursor: pointer; text-align: center; line-height: 1.35;
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  -webkit-user-select: none; user-select: none; -webkit-appearance: none;
  touch-action: manipulation;
}
.abtn .ic { font-size: 1.1rem; line-height: 1; }
.abtn:active { transform: scale(.92); }
.zone.win  .abtn:active { background: rgba(41,121,255,.25); border-color: var(--win); }
.zone.lose .abtn:active { background: rgba(255,45,85,.25); border-color: var(--lose); }

/* Flash */
.flash-ov {
  position: absolute; inset: 0; pointer-events: none; border-radius: 14px;
  opacity: 0; transition: opacity .3s;
}
.flash-ov.wf { background: radial-gradient(circle, rgba(41,121,255,.22), transparent 70%); }
.flash-ov.lf { background: radial-gradient(circle, rgba(255,45,85,.22), transparent 70%); }
.flash-ov.on { opacity: 1; }

/* ‚îÄ STATS PAGE ‚îÄ */
.stats-pg { padding: 10px; gap: 10px; flex-direction: column; }

.scard {
  background: var(--card); border: 1px solid var(--border2);
  border-radius: 13px; overflow: hidden; flex-shrink: 0;
}
.scard-title {
  padding: 8px 13px; font-size: .63rem; font-weight: 800;
  text-transform: uppercase; letter-spacing: 1.5px;
  border-bottom: 1px solid var(--border); color: var(--muted2);
  background: rgba(0,0,0,.2);
}
.srows { padding: 7px 12px; display: flex; flex-direction: column; gap: 3px; }
.srow {
  display: flex; align-items: center; justify-content: space-between;
  padding: 4px 2px; font-size: .76rem;
}
.sl { color: var(--muted2); }
.sv { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: .78rem; }
.sv.w { color: var(--win); } .sv.l { color: var(--lose); }
.sdiv { height: 1px; background: var(--border); margin: 3px 0; }
.pct-block { padding: 4px 12px 10px; }
.pct-row { display: flex; justify-content: space-between; font-size: .74rem; margin-top: 5px; }
.pct-lbl { color: var(--muted2); }
.pct-val { font-family: 'JetBrains Mono', monospace; font-weight: 700; }
.pct-val.w { color: var(--win); } .pct-val.l { color: var(--lose); }
.bar-bg { height: 4px; background: var(--border2); border-radius: 2px; margin-top: 3px; }
.bar-fill { height: 4px; border-radius: 2px; transition: width .4s; }

.next-wrap { padding: 10px; display: flex; flex-direction: column; gap: 7px; flex-shrink: 0; }
.next-btn {
  width: 100%; padding: 13px; border-radius: 11px;
  border: 1.5px solid var(--green); background: rgba(0,230,118,.07);
  color: var(--green); font-family: 'Outfit', sans-serif;
  font-size: .88rem; font-weight: 800; cursor: pointer;
}
.next-btn:active { background: rgba(0,230,118,.18); }
.menu-btn-mob {
  width: 100%; padding: 11px; border-radius: 11px;
  border: 1.5px solid var(--muted); background: transparent;
  color: var(--muted2); font-family: 'Outfit', sans-serif;
  font-size: .82rem; font-weight: 700; cursor: pointer;
}
.menu-btn-mob:active { background: var(--border); }

/* ‚îÄ HISTORY PAGE ‚îÄ */
.hist-pg { padding: 8px; gap: 4px; flex-direction: column; }
.ritem {
  display: flex; align-items: flex-start; gap: 8px;
  padding: 9px 10px; border-radius: 9px;
  background: var(--card); border: 1px solid var(--border);
  font-size: .74rem; flex-shrink: 0;
}
.rdot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; margin-top: 3px; }
.rinfo { flex: 1; min-width: 0; }
.rnum { font-family: 'JetBrains Mono', monospace; font-size: .62rem; color: var(--muted); margin-right: 4px; }
.rmain { font-weight: 700; }
.rmain.w { color: #7cb8ff; } .rmain.l { color: #ff8fa3; }
.rsub { color: var(--muted2); margin-top: 2px; font-size: .68rem; line-height: 1.4; }
.rdel { background: none; border: none; color: var(--muted); cursor: pointer; font-size: .9rem; padding: 2px 4px; border-radius: 4px; flex-shrink: 0; }
.rdel:active { color: var(--lose); }

/* ‚ïê‚ïê‚ïê TABLET LANDSCAPE ‚ïê‚ïê‚ïê */
@media (min-width: 700px) and (orientation: landscape) {
  .tabs { display: none; }
  .content { flex-direction: row; }
  .page { display: flex !important; }
  .players-pg { width: 58%; border-right: 1px solid var(--border); overflow-y: auto; }
  .stats-pg { width: 22%; border-right: 1px solid var(--border); overflow-y: auto; }
  .hist-pg { width: 20%; overflow-y: auto; }
  .next-wrap { display: none; }
  .hbtn.next-hdr { display: flex !important; }
}
@media (min-width: 1000px) {
  .players-pg { width: 55%; }
  .stats-pg { width: 24%; }
  .hist-pg { width: 21%; }
}

/* Animations */
@keyframes pw { 0%,100%{transform:scale(1)} 50%{transform:scale(1.18)} }
@keyframes pl { 0%,100%{transform:scale(1)} 50%{transform:scale(1.18)} }
.pw { animation: pw .22s ease; }
.pl { animation: pl .22s ease; }

::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê CONFIG MODAL ‚ïê‚ïê‚ïê -->
<div class="cfg-modal" id="cfg-modal">
  <div class="cfg-box">
    <div class="cfg-logo">BadStats</div>
    <div class="cfg-sub">Suivi statistique badminton</div>

    <div class="mode-tabs">
      <button class="mode-tab on" id="tab-s" onclick="setMode('single')">
        üè∏ Simple <span>1 joueur</span>
      </button>
      <button class="mode-tab" id="tab-d" onclick="setMode('double')">
        üè∏üè∏ Double <span>2 joueurs</span>
      </button>
    </div>

    <div class="cfg-group">
      <div class="cfg-group-title">Nos joueurs</div>
      <div class="cfg-row">
        <div class="cfg-field"><label>Joueur 1</label><input type="text" id="inp-p1" placeholder="Pr√©nom" value="Joueur 1"></div>
        <div class="cfg-field" id="inp-p2-wrap" style="display:none"><label>Joueur 2</label><input type="text" id="inp-p2" placeholder="Pr√©nom" value="Joueur 2"></div>
      </div>
    </div>

    <div class="cfg-group">
      <div class="cfg-group-title">Adversaire</div>
      <div class="cfg-row">
        <div class="cfg-field"><label>Nom / √âquipe</label><input type="text" id="inp-opp" placeholder="Adversaire" value="Adversaire"></div>
      </div>
    </div>

    <div class="cfg-group">
      <div class="cfg-group-title">Informations</div>
      <div class="cfg-row">
        <div class="cfg-field"><label>Comp√©tition</label><input type="text" id="inp-comp" placeholder="Ex: R√©gionale 1"></div>
        <div class="cfg-field"><label>Date</label><input type="date" id="inp-date"></div>
      </div>
    </div>

    <button class="cfg-start" onclick="startMatch()">‚ñ∂ D√©marrer le match</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê EXPORT MODAL ‚ïê‚ïê‚ïê -->
<div class="exp-modal" id="exp-modal">
  <div class="exp-box">
    <h2>Export des donn√©es</h2>
    <div class="exp-pre" id="exp-content"></div>
    <div class="exp-actions">
      <button class="ebtn sec" onclick="closeExp()">Fermer</button>
      <button class="ebtn pri" onclick="copyExp()">Copier JSON</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê -->
<div class="app">

  <!-- HEADER -->
  <div class="hdr">
    <div class="score-row">
      <div class="score-side">
        <div class="score-label" id="hdr-a">Nous</div>
        <div class="score-num w" id="sc-a">0</div>
      </div>
      <div class="score-dash">‚Äì</div>
      <div class="score-side">
        <div class="score-num l" id="sc-b">0</div>
        <div class="score-label" id="hdr-b">Adversaire</div>
      </div>
    </div>
    <div class="set-row" id="set-pills"></div>
    <div class="btn-row">
      <button class="hbtn green" onclick="goMenu()">‚¨Ö Menu</button>
      <button class="hbtn blue" onclick="undoLast()">‚Ü© Annuler</button>
      <button class="hbtn next-hdr" style="display:none;border-color:var(--green);color:var(--green)" onclick="nextSet()">Set suivant ‚Üí</button>
      <button class="hbtn" onclick="openExp()">Export</button>
      <button class="hbtn red" onclick="doReset()">Reset</button>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab on" onclick="showTab('players')">üè∏ Points</button>
    <button class="tab" onclick="showTab('stats')">üìä Stats</button>
    <button class="tab" onclick="showTab('hist')">üìã Historique</button>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- PLAYERS -->
    <div class="page players-pg on" id="pg-players"></div>

    <!-- STATS -->
    <div class="page stats-pg" id="pg-stats">
      <div class="scard">
        <div class="scard-title">Set en cours</div>
        <div class="srows">
          <div class="srow"><span class="sl">Points totaux</span><div style="display:flex;gap:14px"><span class="sv w" id="s-tw">0</span><span class="sv l" id="s-tl">0</span></div></div>
          <div class="sdiv"></div>
          <div class="srow" style="color:rgba(41,121,255,.8);font-size:.68rem;font-weight:800">‚úÖ GAGN√âS</div>
          <div class="srow"><span class="sl">Plac√©</span><span class="sv w" id="s-w-pl">0</span></div>
          <div class="srow"><span class="sl">Smash / Match</span><span class="sv w" id="s-w-ma">0</span></div>
          <div class="srow"><span class="sl">Erreur adverse</span><span class="sv w" id="s-w-ae">0</span></div>
          <div class="srow"><span class="sl">Sortie adverse</span><span class="sv w" id="s-w-so">0</span></div>
          <div class="srow"><span class="sl">Service</span><span class="sv w" id="s-w-sv">0</span></div>
          <div class="sdiv"></div>
          <div class="srow" style="color:rgba(255,45,85,.8);font-size:.68rem;font-weight:800">‚ùå PERDUS</div>
          <div class="srow"><span class="sl">Filet</span><span class="sv l" id="s-l-fi">0</span></div>
          <div class="srow"><span class="sl">Hors limite</span><span class="sv l" id="s-l-hl">0</span></div>
          <div class="srow"><span class="sl">Erreur</span><span class="sv l" id="s-l-er">0</span></div>
          <div class="srow"><span class="sl">Service</span><span class="sv l" id="s-l-sv">0</span></div>
          <div class="srow"><span class="sl">Plac√© (adv)</span><span class="sv l" id="s-l-pl">0</span></div>
          <div class="srow"><span class="sl">Smash adv</span><span class="sv l" id="s-l-ma">0</span></div>
        </div>
        <div class="pct-block">
          <div class="pct-row"><span class="pct-lbl">% Points construits</span><span class="pct-val w" id="pct-w">‚Äî</span></div>
          <div class="bar-bg"><div class="bar-fill" style="background:var(--win);width:0%" id="bar-w"></div></div>
          <div class="pct-row"><span class="pct-lbl">% Fautes directes</span><span class="pct-val l" id="pct-l">‚Äî</span></div>
          <div class="bar-bg"><div class="bar-fill" style="background:var(--lose);width:0%" id="bar-l"></div></div>
        </div>
      </div>
      <div id="player-stat-cards"></div>
      <div class="next-wrap">
        <button class="next-btn" onclick="nextSet()">Fin de set ‚Üí Set suivant</button>
        <button class="menu-btn-mob" onclick="goMenu()">‚¨Ö Retour au menu</button>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="page hist-pg" id="pg-hist">
      <div id="rally-log" style="display:flex;flex-direction:column;gap:4px">
        <div style="text-align:center;color:var(--muted);font-size:.75rem;margin-top:24px;line-height:2">Aucun point<br>enregistr√©.</div>
      </div>
      <div class="next-wrap">
        <button class="next-btn" onclick="nextSet()">Fin de set ‚Üí Set suivant</button>
        <button class="menu-btn-mob" onclick="goMenu()">‚¨Ö Retour au menu</button>
      </div>
    </div>

  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DEFINITIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const WIN_ACTIONS = [
  {key:'place',  ic:'üéØ', lbl:'Plac√©'},
  {key:'match',  ic:'üí•', lbl:'Smash/Match'},
  {key:'adverr', ic:'‚ö°', lbl:'Erreur adv.'},
  {key:'sortie', ic:'üìê', lbl:'Sortie adv.'},
  {key:'service',ic:'üè∏', lbl:'Service'},
];
const LOSE_ACTIONS = [
  {key:'filet',  ic:'üï∏Ô∏è', lbl:'Filet'},
  {key:'hl',     ic:'üìè', lbl:'Hors limite'},
  {key:'err',    ic:'‚ö†Ô∏è',  lbl:'Erreur'},
  {key:'service',ic:'üö´', lbl:'Service'},
  {key:'place',  ic:'üéØ', lbl:'Plac√© (adv)'},
  {key:'match',  ic:'üí•', lbl:'Smash adv'},
];
const WL = {place:'Plac√© (gagn√©)',match:'Smash/Match',adverr:'Erreur adverse',sortie:'Sortie adverse',service:'Service (gagn√©)'};
const LL = {filet:'Filet',hl:'Hors limite',err:'Erreur',service:'Service (perdu)',place:'Plac√© (adv)',match:'Smash adv'};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const S = {
  mode:'single', players:['Joueur 1'], opponent:'Adversaire', info:{},
  currentSet:1, sets:[{rallies:[]}],
  scoreA:0, scoreB:0, rallyId:0,
};

let uiMode = 'single';
document.getElementById('inp-date').valueAsDate = new Date();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setMode(m) {
  uiMode = m;
  document.getElementById('tab-s').classList.toggle('on', m==='single');
  document.getElementById('tab-d').classList.toggle('on', m==='double');
  document.getElementById('inp-p2-wrap').style.display = m==='double' ? '' : 'none';
}

function startMatch() {
  S.mode = uiMode;
  S.players = [document.getElementById('inp-p1').value.trim() || 'Joueur 1'];
  if (S.mode === 'double') S.players.push(document.getElementById('inp-p2').value.trim() || 'Joueur 2');
  S.opponent = document.getElementById('inp-opp').value.trim() || 'Adversaire';
  S.info = { competition: document.getElementById('inp-comp').value, date: document.getElementById('inp-date').value };

  document.getElementById('hdr-a').textContent = S.mode === 'single' ? S.players[0] : S.players.join(' & ');
  document.getElementById('hdr-b').textContent = S.opponent;
  document.getElementById('cfg-modal').classList.add('hidden');

  buildCards();
  refreshAll();
  showTab('players');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BUILD PLAYER CARDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildCards() {
  const area = document.getElementById('pg-players');
  area.innerHTML = '';
  area.classList.toggle('single-mode', S.mode === 'single');

  S.players.forEach((name, idx) => {
    const card = document.createElement('div');
    card.className = 'pcard';
    card.id = 'card-' + idx;
    card.innerHTML = `
      <div class="pcard-hdr">
        <div class="pcard-name">${name}</div>
        <div class="pcard-pts"><span class="w" id="pw-${idx}">0</span>W &nbsp;<span class="l" id="pl-${idx}">0</span>L</div>
      </div>
      <div class="pcard-body">
        <div class="zone win">
          <div class="zone-title">‚úÖ Points gagn√©s</div>
          <div class="zone-grid">
            ${WIN_ACTIONS.map(a=>`<button class="abtn" onclick="rec(${idx},'win','${a.key}')"><span class="ic">${a.ic}</span>${a.lbl}</button>`).join('')}
          </div>
        </div>
        <div class="zone lose">
          <div class="zone-title">‚ùå Points perdus</div>
          <div class="zone-grid">
            ${LOSE_ACTIONS.map(a=>`<button class="abtn" onclick="rec(${idx},'lose','${a.key}')"><span class="ic">${a.ic}</span>${a.lbl}</button>`).join('')}
          </div>
        </div>
      </div>
      <div class="flash-ov" id="fl-${idx}"></div>
    `;
    area.appendChild(card);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RECORD POINT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function rec(pIdx, result, action) {
  const rally = {
    id: ++S.rallyId,
    set: S.currentSet,
    player: pIdx,
    playerName: S.players[pIdx],
    result, action,
    timestamp: Date.now(),
  };
  S.sets[S.currentSet-1].rallies.push(rally);
  if (result === 'win') S.scoreA++; else S.scoreB++;
  flash(pIdx, result);
  pulse(result);
  refreshAll();
}

function flash(idx, result) {
  const el = document.getElementById('fl-'+idx);
  if (!el) return;
  el.className = 'flash-ov ' + (result==='win'?'wf':'lf');
  el.classList.add('on');
  setTimeout(() => el.classList.remove('on'), 350);
}

function pulse(result) {
  const el = document.getElementById(result==='win'?'sc-a':'sc-b');
  const cls = result==='win'?'pw':'pl';
  el.classList.remove(cls); void el.offsetWidth; el.classList.add(cls);
  setTimeout(() => el.classList.remove(cls), 280);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DELETE / UNDO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function delRally(id) {
  let removed = null;
  S.sets.forEach(s => {
    const i = s.rallies.findIndex(r => r.id === id);
    if (i !== -1) removed = s.rallies.splice(i, 1)[0];
  });
  if (!removed) return;
  if (removed.result === 'win') S.scoreA = Math.max(0, S.scoreA-1);
  else S.scoreB = Math.max(0, S.scoreB-1);
  refreshAll();
}

function undoLast() {
  for (let i = S.sets.length-1; i >= 0; i--) {
    const s = S.sets[i];
    if (s.rallies.length) { delRally(s.rallies[s.rallies.length-1].id); return; }
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showTab(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
  document.getElementById('pg-'+name).classList.add('on');
  const idx = {players:0, stats:1, hist:2}[name];
  document.querySelectorAll('.tab')[idx].classList.add('on');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REFRESH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function refreshAll() {
  // Header score
  document.getElementById('sc-a').textContent = S.scoreA;
  document.getElementById('sc-b').textContent = S.scoreB;

  // Set pills
  document.getElementById('set-pills').innerHTML = S.sets.map((s,i) => {
    const w = s.rallies.filter(r=>r.result==='win').length;
    const l = s.rallies.filter(r=>r.result==='lose').length;
    return `<div class="set-pill ${(i+1)===S.currentSet?'cur':''}">S${i+1}: ${w}‚Äì${l}</div>`;
  }).join('');

  // Player pts (current set)
  const rs = S.sets[S.currentSet-1].rallies;
  S.players.forEach((_,idx) => {
    const mine = rs.filter(r=>r.player===idx);
    const we = document.getElementById('pw-'+idx); if(we) we.textContent = mine.filter(r=>r.result==='win').length;
    const le = document.getElementById('pl-'+idx); if(le) le.textContent = mine.filter(r=>r.result==='lose').length;
  });

  updateStats(rs);
  renderHistory(rs);
  renderPlayerCards();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateStats(rs) {
  const wins = rs.filter(r=>r.result==='win');
  const loses = rs.filter(r=>r.result==='lose');
  const cw = k => wins.filter(r=>r.action===k).length;
  const cl = k => loses.filter(r=>r.action===k).length;

  document.getElementById('s-tw').textContent = wins.length;
  document.getElementById('s-tl').textContent = loses.length;
  document.getElementById('s-w-pl').textContent = cw('place');
  document.getElementById('s-w-ma').textContent = cw('match');
  document.getElementById('s-w-ae').textContent = cw('adverr');
  document.getElementById('s-w-so').textContent = cw('sortie');
  document.getElementById('s-w-sv').textContent = cw('service');
  document.getElementById('s-l-fi').textContent = cl('filet');
  document.getElementById('s-l-hl').textContent = cl('hl');
  document.getElementById('s-l-er').textContent = cl('err');
  document.getElementById('s-l-sv').textContent = cl('service');
  document.getElementById('s-l-pl').textContent = cl('place');
  document.getElementById('s-l-ma').textContent = cl('match');

  const total = rs.length;
  if (total > 0) {
    const cp = Math.round(((cw('place')+cw('match'))/total)*100);
    const fp = Math.round(((cl('filet')+cl('hl')+cl('err')+cl('service'))/total)*100);
    document.getElementById('pct-w').textContent = cp+'%';
    document.getElementById('pct-l').textContent = fp+'%';
    document.getElementById('bar-w').style.width = cp+'%';
    document.getElementById('bar-l').style.width = fp+'%';
  } else {
    document.getElementById('pct-w').textContent = '‚Äî';
    document.getElementById('pct-l').textContent = '‚Äî';
    document.getElementById('bar-w').style.width = '0%';
    document.getElementById('bar-l').style.width = '0%';
  }
}

function renderPlayerCards() {
  if (S.mode !== 'double') { document.getElementById('player-stat-cards').innerHTML = ''; return; }
  const all = S.sets.flatMap(s=>s.rallies);
  document.getElementById('player-stat-cards').innerHTML = S.players.map((name,idx) => {
    const mine = all.filter(r=>r.player===idx);
    const w = mine.filter(r=>r.result==='win').length;
    const l = mine.filter(r=>r.result==='lose').length;
    const cw = k => mine.filter(r=>r.result==='win'&&r.action===k).length;
    const cl = k => mine.filter(r=>r.result==='lose'&&r.action===k).length;
    return `<div class="scard" style="margin-top:10px">
      <div class="scard-title">${name} ‚Äî Total match</div>
      <div class="srows">
        <div class="srow"><span class="sl">Points</span><div style="display:flex;gap:12px"><span class="sv w">${w}</span><span class="sv l">${l}</span></div></div>
        <div class="sdiv"></div>
        <div class="srow"><span class="sl">Plac√©</span><div style="display:flex;gap:12px"><span class="sv w">${cw('place')}</span><span class="sv l">${cl('place')}</span></div></div>
        <div class="srow"><span class="sl">Smash/Match</span><div style="display:flex;gap:12px"><span class="sv w">${cw('match')}</span><span class="sv l">${cl('match')}</span></div></div>
        <div class="srow"><span class="sl">Filet</span><span class="sv l">${cl('filet')}</span></div>
        <div class="srow"><span class="sl">Hors limite</span><span class="sv l">${cl('hl')}</span></div>
        <div class="srow"><span class="sl">Service (perdu)</span><span class="sv l">${cl('service')}</span></div>
      </div>
    </div>`;
  }).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderHistory(rs) {
  const el = document.getElementById('rally-log');
  if (!rs.length) {
    el.innerHTML = '<div style="text-align:center;color:var(--muted);font-size:.75rem;margin-top:24px;line-height:2">Aucun point<br>dans ce set.</div>';
    return;
  }
  const dc = r => r.result==='win' ? '#2979ff' : '#ff2d55';
  const al = r => r.result==='win' ? (WL[r.action]||r.action) : (LL[r.action]||r.action);
  el.innerHTML = [...rs].reverse().map(r => `
    <div class="ritem">
      <div class="rdot" style="background:${dc(r)}"></div>
      <div class="rinfo">
        <span class="rnum">#${r.id}</span>
        <span class="rmain ${r.result==='win'?'w':'l'}">${r.result==='win'?'‚úÖ Gagn√©':'‚ùå Perdu'}</span>
        <div class="rsub">${al(r)}${S.mode==='double'?' ¬∑ '+r.playerName:''}</div>
      </div>
      <button class="rdel" onclick="delRally(${r.id})">‚úï</button>
    </div>
  `).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SET / MENU / RESET / EXPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function nextSet() {
  S.currentSet++;
  if (!S.sets[S.currentSet-1]) S.sets.push({rallies:[]});
  S.scoreA = 0;
  S.scoreB = 0;
  refreshAll();
  showTab('players');
}

function goMenu() {
  S.sets = [{rallies:[]}]; S.currentSet = 1;
  S.scoreA = 0; S.scoreB = 0; S.rallyId = 0;
  S.players = ['Joueur 1']; S.mode = 'single';
  document.getElementById('cfg-modal').classList.remove('hidden');
  uiMode = 'single';
  document.getElementById('tab-s').classList.add('on');
  document.getElementById('tab-d').classList.remove('on');
  document.getElementById('inp-p2-wrap').style.display = 'none';
}

function doReset() {
  S.sets = [{rallies:[]}]; S.currentSet = 1;
  S.scoreA = 0; S.scoreB = 0; S.rallyId = 0;
  buildCards();
  refreshAll();
  showTab('players');
}

function openExp() {
  const pStats = S.players.map((name,idx) => {
    const all = S.sets.flatMap(s=>s.rallies).filter(r=>r.player===idx);
    const cw = k => all.filter(r=>r.result==='win'&&r.action===k).length;
    const cl = k => all.filter(r=>r.result==='lose'&&r.action===k).length;
    return { player:name, wins:all.filter(r=>r.result==='win').length, losses:all.filter(r=>r.result==='lose').length,
      winDetail:{place:cw('place'),match:cw('match'),adverr:cw('adverr'),sortie:cw('sortie'),service:cw('service')},
      lossDetail:{filet:cl('filet'),horsLimite:cl('hl'),erreur:cl('err'),service:cl('service'),place:cl('place'),match:cl('match')},
    };
  });
  document.getElementById('exp-content').textContent = JSON.stringify({
    matchInfo:{...S.info,players:S.players,opponent:S.opponent,mode:S.mode},
    totals:{us:S.scoreA,them:S.scoreB},
    playerStats:pStats,
    sets:S.sets.map((s,i)=>({set:i+1,us:s.rallies.filter(r=>r.result==='win').length,them:s.rallies.filter(r=>r.result==='lose').length,rallies:s.rallies})),
  }, null, 2);
  document.getElementById('exp-modal').classList.add('show');
}
function closeExp() { document.getElementById('exp-modal').classList.remove('show'); }
function copyExp() { navigator.clipboard.writeText(document.getElementById('exp-content').textContent).then(() => alert('Copi√© !')); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SERVICE WORKER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  });
}
</script>
</body>
</html>
